<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Standort erfassen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#365743;--card:#abe38f;--line:#e5e7eb;--brand:#0f172a;--accent:#0ea5e9;--muted:#667085;--color:#f0f7f3}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,Segoe UI,Roboto,Arial}
    main{max-width:720px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,.06);padding:24px}
    h2{margin:0 0 8px;font-size:26px;color:var(--brand)}
    h1{margin:0 0 8px;font-size:26px;color:var(--brand)}
    p.hint{margin:0 0 16px;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    input[type="text"]{flex:1 1 220px;min-width:220px;padding:12px;border:1px solid var(--line);border-radius:10px;font-size:16px}
    button{padding:12px 16px;border-radius:10px;border:1px solid var(--brand);background:var(--brand);color:#fff;cursor:pointer;font-weight:600}
    button.secondary{background:#fff;color:var(--brand)}
    #msg{margin-top:8px;color:#b45309}
    .actions{display:none;gap:10px;flex-wrap:wrap;margin-top:12px}
  </style>
</head>
<body>
  <main>
    <div class="card">
      <h1>üìù Forstauftrag:</h1>
      <h2>üìç Standort automatisch ermitteln</h2>
      <p class="hint">
        Bitte Standortzugriff im Browser erlauben.<br />
        Safari: <strong>Einstellungen ‚Üí Datenschutz &amp; Sicherheit ‚Üí Ort ‚Üí Safari ‚Üí Aktivieren</strong><br />
        Android: <strong>Standortdienste aktivieren + Browser-Berechtigung zulassen</strong>
      </p>

      <div class="row">
        <input type="text" id="latitude"  placeholder="Breitengrad (z. B. 48.137154)" />
        <input type="text" id="longitude" placeholder="L√§ngengrad (z. B. 11.576124)" />
      </div>

      <div class="row">
        <button id="btn-locate">üì° Standort ermitteln &amp; Formular √∂ffnen</button>
        <button id="btn-open-manual" class="secondary">‚úçÔ∏è Manuell eingeben &amp; √∂ffnen</button>
        <button id="btn-open-empty"  class="secondary">‚Ü™Ô∏è Ohne Koordinaten fortfahren</button>
      </div>

      <div id="msg"></div>
      <div id="actions" class="actions">
        <button id="btn-open-manual-2" class="secondary">‚úçÔ∏è Manuell eingeben &amp; √∂ffnen</button>
        <button id="btn-open-empty-2"  class="secondary">‚Ü™Ô∏è Ohne Koordinaten fortfahren</button>
      </div>
    </div>
  </main>

  <script>
    const DEFAULT_FORM_URL = "https://n8n.ryzeup.ai/form-test/2d6de1b5-94ca-48a0-910d-4732073b32da";
    const FORM_URL = new URLSearchParams(location.search).get("next") || DEFAULT_FORM_URL;

    const $ = sel => document.querySelector(sel);
    const msg = $("#msg");
    const actions = $("#actions");
    const latEl = $("#latitude");
    const lonEl = $("#longitude");

    function normalizeCoord(v){ if(!v) return null; v=String(v).trim().replace(",","."); const n=Number(v); return Number.isFinite(n)?n:null; }
    function isValidLat(v){ return v>=-90 && v<=90; }
    function isValidLon(v){ return v>=-180 && v<=180; }

    function openFormWith(lat, lon){ const u=new URL(FORM_URL); u.searchParams.set("lat", lat.toFixed(6)); u.searchParams.set("lon", lon.toFixed(6)); location.href=u.toString(); }
    function openFormNoGeo(){ const u=new URL(FORM_URL); u.searchParams.set("noGeo","1"); location.href=u.toString(); }

    document.getElementById("btn-locate").addEventListener("click", () => {
      msg.textContent = "Bitte Standortfreigabe erlauben‚Ä¶";
      actions.style.display = "none";
      if (!navigator.geolocation){ msg.textContent="Geolocation wird von diesem Browser nicht unterst√ºtzt."; actions.style.display="flex"; return; }
      navigator.geolocation.getCurrentPosition(
        p => { const lat=p.coords.latitude; const lon=p.coords.longitude; latEl.value=lat.toFixed(6); lonEl.value=lon.toFixed(6); openFormWith(lat, lon); },
        err => { msg.textContent="Ohne Koordinaten k√∂nnen keine Rettungspunkte ermittelt werden."; actions.style.display="flex"; },
        { enableHighAccuracy:true, timeout:15000 }
      );
    });

    function handleManualOpen(){ const lat=normalizeCoord(latEl.value); const lon=normalizeCoord(lonEl.value);
      if(lat==null || lon==null || !isValidLat(lat) || !isValidLon(lon)){ msg.textContent="Bitte g√ºltige Koordinaten eingeben (Lat ‚àí90..90, Lon ‚àí180..180) oder ‚ÄûOhne Koordinaten fortfahren‚Äú."; return; }
      openFormWith(lat, lon);
    }
    document.getElementById("btn-open-manual").addEventListener("click", handleManualOpen);
    document.getElementById("btn-open-manual-2").addEventListener("click", handleManualOpen);
    document.getElementById("btn-open-empty").addEventListener("click", openFormNoGeo);
    document.getElementById("btn-open-empty-2").addEventListener("click", openFormNoGeo);
  </script>
</body>
</html>
